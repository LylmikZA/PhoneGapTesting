<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <title>Page 1</title>
    <link rel="stylesheet" href="css/mystylesheet.css" />
    <link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
  </head>
  <body>
    <div class="mytoolbar" id="toolbar">
      <ul>
        <li>Push Msg</li>
        <li style="float:right"><a href="#" onclick="gotoHome()"><img src="img/icon/home.png"/></a></li>
      </ul>
    </div>    
    <div class="main">
      <button type="button" onclick="initPush()">Init</button>
      <button type="button" onclick="resetUI()">ResetUI</button>
      <div id='pushInfo'>Getting registration Id...<br/></div>
    </div>
    <div>

      <!-- Container for the Table of content -->
      <div>
        <div>
          <!-- div to display the generated Instance ID token -->
          <div id="token_div" style="display: none;">
            <h4>Instance ID Token</h4>
            <p id="token" style="word-break: break-all;"></p>
            <button onclick="deleteToken()">Delete Token</button>
          </div>
          <!-- div to display the UI to allow the request for permission to
               notify the user. This is shown if the app has not yet been
               granted permission to notify. -->
          <div id="permission_div" style="display: none;">
            <h4>Needs Permission</h4>
            <p id="token"></p>
            <button onclick="requestPermission()">Request Permission</button>
          </div>
          <!-- div to display messages received by this app. -->
          <div id="messages"></div>
        </div>
      </div>

    </div>

    <script src="https://www.gstatic.com/firebasejs/4.3.0/firebase.js"></script>
    <script type="text/javascript">
      var TAG = "push: ";
      document.addEventListener("deviceready", onDeviceReady, false);
      var messaging;
      const tokenDivId = 'token_div';
      const permissionDivId = 'permission_div';

      function onDeviceReady() {
          console.log(TAG + "device ready")
          document.addEventListener("backbutton", BackKeyDown, true);
      }

      function initPush() {
          var config = {
              apiKey: "AIzaSyCcO_c2tDvvmJp5VapX57uYMlW3qdxSk8s",
              authDomain: "phonegap-test-1503307124052.firebaseapp.com",
              databaseURL: "https://phonegap-test-1503307124052.firebaseio.com",
              projectId: "phonegap-test-1503307124052",
              storageBucket: "phonegap-test-1503307124052.appspot.com",
              messagingSenderId: "79759081709"
          };
          firebase.initializeApp(config);

          messaging = firebase.messaging();
          messaging.onTokenRefresh(function () {
              messaging.getToken()
                      .then(function (refreshedToken) {
                          console.log('Token refreshed.');
                          // Indicate that the new Instance ID token has not yet been sent to the
                          // app server.
                          setTokenSentToServer(false);
                          // Send Instance ID token to app server.
                          sendTokenToServer(refreshedToken);
                          // [START_EXCLUDE]
                          // Display new Instance ID token and clear UI of all previous messages.
                          resetUI();
                          // [END_EXCLUDE]
                      })
                      .catch(function (err) {
                          console.log('Unable to retrieve refreshed token ', err);
                          showToken('Unable to retrieve refreshed token ', err);
                      });
          });

          messaging.onMessage(function (payload) {
              console.log("Message received. ", payload);
              // [START_EXCLUDE]
              // Update the UI to include the received message.
              appendMessage(payload);
              // [END_EXCLUDE]
          });

          resetUI();
      }

      function resetUI() {
//          clearMessages();
          showToken('loading...');
          // [START get_token]
          // Get Instance ID token. Initially this makes a network call, once retrieved
          // subsequent calls to getToken will return from cache.
          messaging.getToken()
                  .then(function (currentToken) {
                      if (currentToken) {
                          sendTokenToServer(currentToken);
                          updateUIForPushEnabled(currentToken);
                      } else {
                          // Show permission request.
                          console.log('No Instance ID token available. Request permission to generate one.');
                          // Show permission UI.
                          updateUIForPushPermissionRequired();
                          setTokenSentToServer(false);
                      }
                  })
                  .catch(function (err) {
                      console.log('An error occurred while retrieving token. ', err);
                      showToken('Error retrieving Instance ID token. ', err);
                      setTokenSentToServer(false);
                  });
      }

      function showToken(currentToken) {
          // Show token in console and UI.
          var tokenElement = document.querySelector('#token');
          tokenElement.textContent = currentToken;
      }
      // Send the Instance ID token your application server, so that it can:
      // - send messages back to this app
      // - subscribe/unsubscribe the token from topics
      function sendTokenToServer(currentToken) {
          if (!isTokenSentToServer()) {
              console.log('Sending token to server...');
              // TODO(developer): Send the current token to your server.
              setTokenSentToServer(true);
          } else {
              console.log('Token already sent to server so won\'t send it again ' +
                      'unless it changes');
          }
      }
      function isTokenSentToServer() {
          return window.localStorage.getItem('sentToServer') == 1;
      }
      function setTokenSentToServer(sent) {
          window.localStorage.setItem('sentToServer', sent ? 1 : 0);
      }
      function showHideDiv(divId, show) {
          const div = document.querySelector('#' + divId);
          if (show) {
              div.style = "display: visible";
          } else {
              div.style = "display: none";
          }
      }
      function requestPermission() {
          console.log('Requesting permission...');
          // [START request_permission]
          messaging.requestPermission()
                  .then(function () {
                      console.log('Notification permission granted.');
                      // TODO(developer): Retrieve an Instance ID token for use with FCM.
                      // [START_EXCLUDE]
                      // In many cases once an app has been granted notification permission, it
                      // should update its UI reflecting this.
                      resetUI();
                      // [END_EXCLUDE]
                  })
                  .catch(function (err) {
                      console.log('Unable to get permission to notify.', err);
                  });
          // [END request_permission]
      }
      function deleteToken() {
          // Delete Instance ID token.
          // [START delete_token]
          messaging.getToken()
                  .then(function (currentToken) {
                      messaging.deleteToken(currentToken)
                              .then(function () {
                                  console.log('Token deleted.');
                                  setTokenSentToServer(false);
                                  // [START_EXCLUDE]
                                  // Once token is deleted update UI.
                                  resetUI();
                                  // [END_EXCLUDE]
                              })
                              .catch(function (err) {
                                  console.log('Unable to delete token. ', err);
                              });
                      // [END delete_token]
                  })
                  .catch(function (err) {
                      console.log('Error retrieving Instance ID token. ', err);
                      showToken('Error retrieving Instance ID token. ', err);
                  });
      }
      // Add a message to the messages element.
      function appendMessage(payload) {
          const messagesElement = document.querySelector('#messages');
          const dataHeaderELement = document.createElement('h5');
          const dataElement = document.createElement('pre');
          dataElement.style = 'overflow-x:hidden;'
          dataHeaderELement.textContent = 'Received message:';
          dataElement.textContent = JSON.stringify(payload, null, 2);
          messagesElement.appendChild(dataHeaderELement);
          messagesElement.appendChild(dataElement);
      }
      // Clear the messages element of all children.
      function clearMessages() {
          const messagesElement = document.querySelector('#messages');
          while (messagesElement.hasChildNodes()) {
              messagesElement.removeChild(messagesElement.lastChild);
          }
      }
      function updateUIForPushEnabled(currentToken) {
          showHideDiv(tokenDivId, true);
          showHideDiv(permissionDivId, false);
          showToken(currentToken);
      }
      function updateUIForPushPermissionRequired() {
          showHideDiv(tokenDivId, false);
          showHideDiv(permissionDivId, true);
      }

      function gotoHome()
      {
          window.location = "menu.html";
      }

      function BackKeyDown()
      {
          console.log(TAG + "Back Pressed");
          gotoHome();
      }
    </script>
    <script type="text/javascript" src="cordova.js"></script>
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/jquery.mobile-1.4.5.min.js"></script>
  </body>
</html>